<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cykj.hospitalsystem.mapper.RoutesMapper">
    <select id="authorityMenu" resultMap="RoutesState" parameterType="Map">
        select * from routes r left join tbldata d on r.rstate=d.dataid
        <where>
            <if test="exceptMstate!=null and exceptMstate!=''">
                rstate!=#{exceptMstate}
            </if>
            <if test="routesStateValue!=null and routesStateValue!='' and routesStateValue!=18">
                and rstate=#{routesStateValue}
            </if>
            <if test="label!=null and label!=''">
                and label=#{label}
            </if>
        </where>
    </select>
    <resultMap id="RoutesState" type="Routes">
        <id property="rid" column="rid"/>
        <result property="pid" column="pid"/>
        <result property="path" column="path"/>
        <result property="component" column="component"/>
        <result property="label" column="label"/>
        <result property="icon" column="icon"/>
        <result property="redirect" column="redirect"/>
        <result property="rstate" column="rstate"/>
        <result property="rname" column="rname"/>
        <association property="tbldata" javaType="Tbldata">
            <result property="dataname" column="dataname"></result>
        </association>
    </resultMap>
    <select id="getRoutesId" resultType="Routes" parameterType="Map">
        select routes.rid,routes.pid
        from routes routes LEFT JOIN tblrolepower rp on routes.rid= rp.menuid
        LEFT JOIN tblrole tr on tr.roleid=rp.roleid
        and tr.rolestate=2 and rp.state=1 where tr.roleid=#{roleid} and routes.rstate = 2
    </select>

    <select id="roleGetNotInId" parameterType="Map" resultType="Routes">
        select rid from routes where rid not in
        (select menuid from tblrolepower where roleid=#{roleid}) and rstate = 2
    </select>

    <select id="byRolepowerGetRoutes" resultType="Routes">
        select * from routes  where rstate=2 and rid in
        <foreach item="rolepower" collection="list" open="(" separator="," close=")">
            #{rolepower.menuid}
        </foreach>
    </select>


    <!--批量修改状态-->
    <update id="setRoutesState" >
        update routes
        <set>
            <if test="map.rstate != null and map.rstate != ''">rstate=#{map.rstate}</if>
        </set>
        where rid in
        <foreach item="item" index="index" collection="map.ridArry" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <!--修改菜单数据-->
    <update id="updateRoutesData" parameterType="Map">
        update routes
        <set>
            <if test="pid != null and pid !=''">pid=#{pid},</if>
            <if test="path != null and path !=''">path=#{path},</if>
            <if test="component != null and component !=''">component=#{component},</if>
            <if test="label != null and label !=''">label=#{label},</if>
            <if test="rname != null and rname !=''">rname=#{rname},</if>
            <if test="icon != null and icon !=''">icon=#{icon}</if>
        </set>
        where rid=#{rid}
    </update>
    <!--新增菜单-->
    <insert id="addMenu" parameterType="Map">
        insert into routes
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="pid!=null and pid!=''">pid,</if>
            <if test="path!=null and path!=''">path,</if>
            <if test="component!=null and component!=''">component,</if>
            <if test="label!=null and label!=''">label,</if>
            <if test="icon!=null and icon!=''">icon,</if>
            <if test="rname!=null and rname!=''">rname,</if>
            <if test="rstate!=null and rstate!=''">rstate</if>
        </trim>
        <trim prefix="values(" suffix=")" suffixOverrides=",">
            <if test="pid!=null and pid!=''">#{pid},</if>
            <if test="path!=null and path!=''">#{path},</if>
            <if test="component!=null and component!=''">#{component},</if>
            <if test="label!=null and label!=''">#{label},</if>
            <if test="icon!=null and icon!=''">#{icon},</if>
            <if test="rname!=null and rname!=''">#{rname},</if>
            <if test="rstate!=null and rstate!=''">#{rstate}</if>
        </trim>
    </insert>
    <select id="menuValues" parameterType="Map" resultType="Routes">
        select * from routes where label &lt;&gt; 'PDA菜单管理' and rstate != 4
    </select>
</mapper>
